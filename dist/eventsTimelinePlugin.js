!function(e,t,i,s){"use strict";var n="eventsTimeLine",a=0,d={start:0,finish:24,legendHeight:"auto",zoomLevel:1,eventDescHeight:200,timeLabelWidth:40},l=420,r=960,o=1240,h=[100,100,110,120,130,140,150,160,170,185,200],c=["01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","24:00"],g=60*(new Date).getTimezoneOffset()*1e3;function f(t,i,s){this.element=t,this.args=arguments,this._$pluginContainer=e(t),this._totalDuration=0,this.timeShift=g,this.settings=d,this._name=n,this.init()}e.extend(f.prototype,{init:function(){var t,i=[];if(a+=1,this.args[1]&&this.args[2]){if(!Array.isArray(this.args[1])||this.args[2]!==Object(this.args[2]))return;this.settings=e.extend({},this.settings,this.args[2]),i=this.args[1].sort(function(e,t){var i=new Date(e.date),s=new Date(t.date);return i.getTime()-s.getTime()}),t="";for(var s=0;s<i.length;s++)t+='<div data-date="'+i[s].date+'" data-type="'+i[s].type+'" data-icon="'+i[s].icon+'" data-title="'+i[s].title+'" data-text="'+i[s].text+'" class="events-item">'+i[s].text+"</div> ";this._$pluginContainer.html(t)}else if(this.args[1]!==Object(this.args[1])||Array.isArray(this.args[1])){if(Array.isArray(this.args[1])){i=this.args[1].sort(function(e,t){var i=new Date(e.date),s=new Date(t.date);return i.getTime()-s.getTime()}),t="";for(var n=0;n<i.length;n++)t+='<div data-date="'+i[n].date+'" data-type="'+i[n].type+'" data-icon="'+i[n].icon+'" data-title="'+i[n].title+'" data-text="'+i[n].text+'" class="events-item">'+i[n].text+"</div> ";this._$pluginContainer.html(t)}}else this.settings=e.extend({},this.settings,this.args[1]);i.length||(this.sortEventNodes(this._$pluginContainer),i=this.getEventsListFromContainer(this._$pluginContainer)),this._firstEventDate=i[0].date,this._lastEventDate=i[i.length-1].date,this._totalDuration=this._lastEventDate-this._firstEventDate,this._zoomLevel=1,this._$pluginContainer.addClass("time-line-plugin").attr("id","time-line-plugin-"+a).children().wrapAll('<div class="time-line"><div class="events"></div></div>'),this._$pluginContainer.prepend('<div class="controls"><button type="button" class="control scroll-left"> < </button><button type="button" class="control scroll-right"> > </button><button type="button" class="control zoom-in"> + </button><button type="button" class="control zoom-out"> - </button></div>').append('<div class="legend"></div>'),this._$timeLine=this._$pluginContainer.find(".time-line"),this._$timeLine.append('<div class="ruler"></div>'),this._$events=this._$timeLine.find(".events"),this._$ruler=this._$timeLine.find(".ruler"),this._$controls=this._$pluginContainer.find(".controls"),this._$legend=this._$pluginContainer.find(".legend"),this._$pluginContainer.find(".legend").css("height",this.settings.legendHeight),this.redraw(),this.drawRuler(),this.minimizeRulerLabels(),this.initLegend(),this.bind(),this.groupEvents(),this.refreshEventsLegend(),this._scrollPos=this._$timeLine.scrollLeft(),this._timeLineWidth=this._$timeLine.width(),console.log(this)},sortEventNodes:function(t){var i=t.find("[data-date]").sort(function(t,i){var s=new Date(e(t).data("date")).getTime(),n=new Date(e(i).data("date")).getTime();return s<n?-1:s>n?1:0});return t.html("").append(i),console.dir(i),t},getEventsListFromContainer:function(t){var i=[];return t.find("[data-type][data-date]").each(function(t,s){var n={};n.date=e(s).data("date"),n.type=e(s).data("type"),n.icon=e(s).data("icon"),n.title=e(s).data("title"),n.text=e(s).text(),i.push(n)}),i},drawRuler:function(){for(var t=this._$ruler,i=this.settings.start;i<this.settings.finish;i++){var s=e('<div class="unit-hh" data-value="'+c[i]+'"><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i><i></i></div>');if(i===this.settings.start){var n=("0"+i).slice(-2)+":00";s.attr("data-start-hour",""+n)}s.css("width",100/(this.settings.finish-this.settings.start)+"%"),t.append(s)}this._$timeLine.append(t)},minimizeRulerLabels:function(){var e=this.settings.timeLabelWidth,t=(this.settings.finish-this.settings.start+1)*e,i=this._$ruler.width();console.log(t,i),t>i&&t<2*i?(this._$ruler.addClass("compact-even"),this._$ruler.removeClass("compact-all")):t>2*i?(this._$ruler.addClass("compact-all"),this._$ruler.removeClass("compact-even")):t<i&&this._$ruler.removeClass("compact-all compact-even")},groupEvents:function(){for(var t=this.settings,i=this._$ruler,s=this._$events,n=(this._$legend,s.children(":not(.hidden)")),a=s.find(".events-item:not(.hidden)").width()||40,d=t.start;d<t.finish;d++){var l=n.filter(function(t,i){return new Date(e(i).data("date")).getHours()===d});l.length>1&&r(l)}function r(t){for(var n=0,d=0,l=1;l<t.length;l++){var r=e(t[l]),o=e(t[l-1]),h=r.offset().left<o.offset().left+.666*a;if(h&&(d=l,s.trigger("eventsOverlapping")),!h||l===t.length-1){if(d-n>0){var c,g=e('<div class="group"></div>'),f=t.slice(n,d+1),u=e(f[0]).css("left"),v=e(f[f.length-1]).css("left");u=+u.substring(0,u.length-2),c=((v=+v.substring(0,v.length-2))+u)/2*100/i.width(),g.attr("data-count",f.length).css("left",c+"%"),f.wrapAll(g)}n=l}}}s.children(":not(.hidden)").each(function(t,i){var s=e(i),n=s.next(),d=!!n.offset()&&n.offset().left<s.offset().left+.666*a;if(d&&s.hasClass("group"))n.hasClass("group")?(n.children().appendTo(s),n.remove(),s.attr("data-count",s.children().length)):(n.appendTo(s),s.attr("data-count",s.children().length));else if(d&&!s.hasClass("group")){if(n.hasClass("group"))s.prependTo(n),n.attr("data-count",n.children().length);else r(e([s[0],n[0]]))}})},ungroupEvents:function(){this._$events.find(".group").each(function(t,i){e(i).children().unwrap(".group")})},refreshSelected:function(){var t=this,i=t._$events,s=t._$legend;i.children(".group").each(function(){var i,n=e(this);n.children().length===n.children(".selected").length?n.addClass("selected").children().each(function(){if(e(this).addClass("selected"),e(this).data("date")!==i){var n=s.find(".selected").length?s.find(".selected"):e('<div class="selected"></div>'),a='.legend-item.in-view[data-date="'+e(this).data("date")+'"]',d=s.find(".cols "+a).clone();0===s.find(".selected "+a).length&&(d.appendTo(n),d.length>1&&(i=e(this).data("date")),n.html(t.sortNodesByDate(n.children())),s.find(".selected").length||n.prependTo(s))}}):n.removeClass("selected").children().each(function(){s.find('.selected .legend-item.in-view[data-date="'+e(this).data("date")+'"]').each(function(){e(this).remove()}),0===s.find(".selected").children().length&&s.find(".selected").remove()})}),i.children(".events-item.selected").each(function(){var i=s.find(".selected").length?s.find(".selected"):e('<div class="selected"></div>'),n='.legend-item.in-view[data-date="'+e(this).data("date")+'"]',a=s.find(".cols "+n).clone();0===s.find(".selected "+n).length&&(a.appendTo(i),a.length>1&&(sameDate=e(this).data("date")),i.html(t.sortNodesByDate(i.children())),s.find(".selected").length||i.prependTo(s))})},redraw:function(){var t=new Date(this._firstEventDate),i=new Date(this._lastEventDate),s=t.getHours(),n=23===i.getHours()?24:i.getHours()+1,a=new Date(this._firstEventDate),d=new Date(this._firstEventDate);"auto"===this.settings.start&&(this.settings.start=s),"auto"===this.settings.finish&&(this.settings.finish=n),a.setHours(this.settings.start,0,0,0),d.setHours(this.settings.finish,0,0,0),this._totalDuration=i.getTime()-t.getTime(),this._$events.children().each(function(t,i){var s,n=e(i),l=new Date(n.data("date")).getTime(),r=l>=a.getTime()&&l<=d.getTime(),o=d.getTime()-a.getTime();r?(s=(o-(d.getTime()-l))/o*100+"%",n.attr("data-text",n.html()).text("").addClass("events-item").addClass("icon-"+n.data("icon")).css("left",s)):n.addClass("hidden")})},zoom:function(e){var t,i,s,n=this._$timeLine,a=this,d=this._zoomLevel;switch(e){case"+":t=10===this._zoomLevel?this._zoomLevel:this._zoomLevel+1;break;case"-":t=1===this._zoomLevel?1:this._zoomLevel-1;break;default:t=this._zoomLevel}this._zoomLevel=t,i=n.scrollLeft(),s=Math.ceil((i+n.width()/2)*(h[t]*t)/(h[d]*d)-n.width()/2),n.animate({scrollLeft:s},300),n.find(".ruler").animate({width:h[t]*t+"%"},300),n.find(".events").animate({width:h[t]*t+"%"},{duration:300,step:function(){a.minimizeRulerLabels()},done:function(){a.ungroupEvents(),a.groupEvents(t),a._scrollPos=n.scrollLeft(),a._timeLineWidth=n.width(),n.trigger("zoom")}})},initLegend:function(){var t=this._$pluginContainer.find(".legend"),i=e("<div></div>");this._$events.children().each(function(t,s){var n=e('<div class="legend-item" data-date="'+e(s).data("date")+'"></div>'),a=new Date(e(s).data("date")),d=a.getHours()+":"+("0"+a.getMinutes()).slice(-2)+":"+("0"+a.getSeconds()).slice(-2)+" "+("0"+a.getDate()).slice(-2)+"."+("0"+(a.getMonth()+1)).slice(-2)+"."+a.getFullYear();n.append('<div class="header icon-'+e(s).data("icon")+'">'+d+"<h4>"+e(s).data("title")+'</h4></div><div class="description">'+e(s).data("text")+"</div>"),i.append(n)}),t.html(i.html())},refreshEventsLegend:function(){var t=this,i=t._$timeLine,s=t._$events,n=t._$legend,a=n.find(".cols"),d=e('<div class="cols"></div>'),h=n.width(),c=i.offset().left,g=i.offset().left+i.width()+2*+i.css("padding-right").slice(0,-2);a.length&&a.children().each(function(t,i){e(i).removeClass("in-view hidden extendable")}).unwrap(".cols"),h<=l?n.removeClass("lg md sm").addClass("xs"):h>l&&h<=r?n.removeClass("lg md xs").addClass("sm"):h>r&&h<=o?n.removeClass("lg sm xs").addClass("md"):h>o&&n.removeClass("md sm xs").addClass("lg"),s.children().each(function(i,s){var a=e(s).offset().left;if(a+e(s).width()>c&&a<g)if(e(s).hasClass("group"))e(s).children().each(function(i,s){var a=e(s).data("date");n.children('.legend-item[data-date="'+a+'"]').each(function(){e(this).addClass("in-view"),e(this).height()>t.settings.eventDescHeight&&e(this).addClass("extendable")})});else if(e(s).hasClass("events-item")){var d=e(s).data("date");n.children('.legend-item[data-date="'+d+'"]').each(function(){e(this).addClass("in-view"),e(this).height()>t.settings.eventDescHeight&&e(this).addClass("extendable")})}}),n.find(".legend-item.in-view:not(.selected .legend-item.in-view)").wrapAll(d)},highlightLegendItem:function(t){var i=this._$legend;if(t.hasClass("group"))t.children().each(function(t,s){var n='.legend-item[data-date="'+e(s).data("date")+'"]';i.find(n).addClass("highlight")});else{var s='.legend-item[data-date="'+t.data("date")+'"]';i.find(s).addClass("highlight")}},unhighlightLegendItem:function(t){var i=this._$legend;if(t.hasClass("group"))t.children().each(function(t,s){var n='.legend-item[data-date="'+e(s).data("date")+'"]';i.find(n).removeClass("highlight")});else{var s='.legend-item[data-date="'+t.data("date")+'"]';this._$legend.find(s).removeClass("highlight")}},resetSelectedEvents:function(){this._$events.find(".selected").each(function(){e(this).removeClass("selected"),e(this).hasClass("group")&&e(this).children(".selected").each(function(){e(this).removeClass("selected")})}),this._$legend.find(".selected").remove()},rescroll:function(e){return this._scrollPos/this._timeLineWidth*e},sortNodesByDate:function(t){return t.sort(function(t,i){var s=new Date(e(t).data("date")).getTime(),n=new Date(e(i).data("date")).getTime();return s<n?-1:s>n?1:0})},bind:function(){var i,s=this,n=(this._$pluginContainer,s._$events),a=this._$timeLine,d=this._$controls,l=this._$ruler,r=this._$legend;e(t).width();e(t).on("resize",function(){i&&clearTimeout(i),i=setTimeout(function(){a.scrollLeft(s.rescroll(s._$timeLine.width())),s.minimizeRulerLabels(),s.ungroupEvents(),s.groupEvents(),s.refreshSelected(),s.refreshEventsLegend(),e(t).width()},300)}),a.on("zoom",function(){a.is(":animated")||(clearTimeout(e.data(this,"zoomTimer")),e.data(this,"zoomTimer",setTimeout(function(){s.resetSelectedEvents(),s.refreshEventsLegend()},100)))}).on("scroll",function(){a.is(":animated")||(clearTimeout(e.data(this,"scrollTimer")),e.data(this,"scrollTimer",setTimeout(function(){s.refreshEventsLegend(),s._scrollPos=a.scrollLeft(),s._timeLineWidth=a.width()},100)))}).on("mouseenter",".events-item, .group",function(){s.highlightLegendItem(e(this))}).on("mouseleave",".events-item, .group",function(){s.unhighlightLegendItem(e(this))}).on("click",function(t){e(t.target).hasClass("events-item")||e(t.target).hasClass("group")||s.resetSelectedEvents()}),d.on("click",".zoom-in",function(){var t=e(this);s.zoom("+"),10===s._zoomLevel?t.attr("disabled",!0):t.attr("disabled",!1),s._$controls.find(".zoom-out").attr("disabled",!1)}).on("click",".zoom-out",function(){s.zoom("-"),1===s._zoomLevel?e(this).attr("disabled",!0):e(this).attr("disabled",!1),s._$controls.find(".zoom-in").attr("disabled",!1)}).on("click",".scroll-right",function(){var e=l.width()/(s.settings.finish-s.settings.start),t=a.scrollLeft()+25;a.animate({scrollLeft:Math.floor(t/e)*e+e},{duration:300,done:function(){a.trigger("scroll")}})}).on("click",".scroll-left",function(){var e=l.width()/(s.settings.finish-s.settings.start),t=a.scrollLeft();a.animate({scrollLeft:Math.ceil(t/e)*e-e},{duration:300,done:function(){a.trigger("scroll")}})}),r.on("click",".legend-item.in-view.extendable .header",function(){e(this).closest(".legend-item").toggleClass("in")}),n.on("click",".events-item",function(){if(e(this).hasClass("selected"))e(this).removeClass("selected"),r.find(".selected").find('.legend-item.in-view[data-date="'+e(this).data("date")+'"]').remove(),0===r.find(".selected").children().length&&r.find(".selected").remove();else{var t=r.find(".selected").length?r.find(".selected"):e('<div class="selected"></div>'),i='.legend-item.in-view[data-date="'+e(this).data("date")+'"]',n=r.find(i).clone();e(this).addClass("selected"),n.appendTo(t),t.html(s.sortNodesByDate(t.children())),r.find(".selected").length||t.prependTo(r)}}).on("click",".group",function(){var t;e(this).hasClass("selected")?e(this).removeClass("selected").children().each(function(){e(this).removeClass("selected"),r.find('.selected .legend-item.in-view[data-date="'+e(this).data("date")+'"]').each(function(){e(this).remove()}),0===r.find(".selected").children().length&&r.find(".selected").remove()}):e(this).addClass("selected").children().each(function(){if(e(this).addClass("selected"),e(this).data("date")!==t){var i=r.find(".selected").length?r.find(".selected"):e('<div class="selected"></div>'),n='.cols .legend-item.in-view[data-date="'+e(this).data("date")+'"]',a=r.find(n).clone();a.appendTo(i),a.length>1&&(t=e(this).data("date")),i.html(s.sortNodesByDate(i.children())),r.find(".selected").length||i.prependTo(r)}})})}}),e.fn[n]=function(t,i){return this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new f(this,t,i))})}}(jQuery,window,document);